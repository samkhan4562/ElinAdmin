<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElinFragrance - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #1f2937; color: #d1d5db; transition: transform 0.3s ease-in-out; z-index: 40; width: 16rem; transform: translateX(-100%); position: fixed; height: 100vh; }
        .sidebar.active { transform: translateX(0); box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); }
        @media (min-width: 1024px) { .sidebar { transform: translateX(0); position: static; height: auto; } }
        .sidebar a { border-left: 3px solid transparent; transition: all 0.2s; }
        .sidebar a:hover { background-color: #374151; }
        .sidebar a.active { background-color: #714329; color: white; border-left-color: #B08463; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background-color: #714329; color: white; }
        .btn-primary:hover { background-color: #5a3521; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-secondary { background-color: #6b7280; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-weight: 600; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 30; display: none; }
        .sidebar-overlay.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body>
<div id="admin-login-view" class="min-h-screen flex items-center justify-center bg-gray-100">
    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
        <h1 class="text-3xl font-bold text-center text-gray-900">ElinFragrance Admin</h1>
        <input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-2 border rounded-lg">
        <input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg">
        <button id="admin-login-btn" class="w-full btn btn-primary">Login</button>
        <p id="login-error" class="text-red-500 text-center"></p>
    </div>
</div>

<div id="admin-dashboard" class="hidden">
    <div class="flex h-screen relative lg:static">
        <div id="sidebar-overlay" class="sidebar-overlay lg:hidden"></div>
        <aside id="sidebar" class="sidebar w-64 flex-shrink-0">
            <div class="p-4 text-2xl font-bold text-white flex justify-between items-center">ElinFragrance Admin <button id="close-sidebar-btn" class="lg:hidden text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <nav class="mt-8">
                <a href="#" class="nav-link block py-3 px-4 active" data-page="dashboard-page"><i data-lucide="layout-grid" class="inline-block w-5 h-5 mr-2"></i>Dashboard</a>
                <a href="#" class="nav-link block py-3 px-4" data-page="products-page"><i data-lucide="package" class="inline-block w-5 h-5 mr-2"></i>Products</a>
                <a href="#" class="nav-link block py-3 px-4" data-page="users-page"><i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i>User Management</a>
                <a href="#" id="admin-logout-btn" class="block py-3 px-4 mt-8"><i data-lucide="log-out" class="inline-block w-5 h-5 mr-2"></i>Logout</a>
            </nav>
        </aside>

        <main class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
            <div class="lg:hidden mb-4"><button id="menu-toggle" class="p-2 bg-gray-200 rounded-md"><i data-lucide="menu" class="w-6 h-6"></i></button></div>

            <div id="dashboard-page" class="page active">
                 <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                     <div class="bg-white p-6 rounded-lg shadow"><h2 class="text-gray-500 text-lg">Total Users</h2><p id="total-users" class="text-4xl font-bold">0</p></div>
                     <div class="bg-white p-6 rounded-lg shadow"><h2 class="text-gray-500 text-lg">Total Products</h2><p id="total-products" class="text-4xl font-bold">0</p></div>
                 </div>
            </div>

            <div id="products-page" class="page">
                 <div class="flex justify-between items-center mb-6">
                     <h1 class="text-3xl font-bold">Product Management</h1>
                     <button id="add-product-btn" class="btn btn-primary"><i data-lucide="plus" class="inline-block w-5 h-5 mr-2"></i>Add Product</button>
                 </div>
                 <div class="bg-white shadow rounded-lg overflow-x-auto"><table class="min-w-full"><thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Actions</th></tr></thead><tbody id="products-table-body"></tbody></table></div>
            </div>

            <div id="users-page" class="page">
                 <h1 class="text-3xl font-bold mb-6">User Management</h1>
                 <div class="mb-4"><input type="text" id="user-search" placeholder="Search by name or email..." class="w-full max-w-md px-4 py-2 border rounded-lg"></div>
                 <div class="bg-white shadow rounded-lg overflow-x-auto"><table class="min-w-full"><thead><tr><th>Username</th><th>Email</th><th>Status</th><th>Flags</th><th>Actions</th></tr></thead><tbody id="users-table-body"></tbody></table></div>
            </div>
            
        </main>
    </div>
</div>

 <div id="product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4 border-b pb-2"><h2 id="product-modal-title" class="text-2xl font-bold">Add Product</h2><button id="product-modal-close-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button></div>
        <form id="product-form" class="space-y-4">
            <input type="hidden" id="product-id">
            <div><label for="p-name" class="block font-semibold mb-1">Product Name</label><input type="text" id="p-name" class="w-full px-3 py-2 border rounded-lg" required></div>
            <div><label for="p-description" class="block font-semibold mb-1">Description</label><textarea id="p-description" class="w-full px-3 py-2 border rounded-lg" rows="3"></textarea></div>
            <div><label for="p-category" class="block font-semibold mb-1">Category</label>
                <select id="p-category" class="w-full px-3 py-2 border rounded-lg" required>
                    <option value="men">Men's Fragrances</option>
                    <option value="women">Women's Fragrances</option>
                    <option value="unisex">Unisex Fragrances</option>
                </select>
            </div>
             <div>
                <label for="p-image" class="block font-semibold mb-1">Image URL</label>
                <input type="text" id="p-image" class="w-full px-3 py-2 border rounded-lg" placeholder="https://images.unsplash.com/..." required>
            </div>
            <div>
                <label class="block font-semibold mb-1">Sizes & Prices</label>
                <div id="p-sizes-container" class="space-y-2">
                    <!-- Dynamic sizes will be added here -->
                </div>
                <button type="button" id="add-size-btn" class="mt-2 text-sm btn btn-secondary">Add Size</button>
            </div>
            <div class="flex justify-end space-x-4 mt-6 border-t pt-4"><button type="button" id="product-modal-cancel-btn" class="btn bg-gray-200 text-gray-800">Cancel</button><button type="submit" class="btn btn-primary">Save Product</button></div>
        </form>
    </div>
</div>

<div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><p id="alert-message" class="mb-4"></p><button id="alert-ok-btn" class="btn btn-primary px-6">OK</button></div></div>
<div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><p id="confirm-message" class="mb-6"></p><div class="flex justify-center space-x-4"><button id="confirm-cancel-btn" class="btn bg-gray-200">Cancel</button><button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button></div></div></div>


<script>
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://ylfgywcjczto.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dWF1bGdmZ3ljb3dqY2NjaXpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMjQ1MDMsImV4cCI6MjA3NDkwMDUwM30.IfgrCv-4oJQpQgz5g8s8a-o8USK8gto0MDinW7BSExc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- GLOBAL STATE ---
    let allUsers = [];
    let allProducts = [];

    // --- INITIALIZATION ---
    window.onload = async () => {
        lucide.createIcons();
        setupEventListeners();
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            document.getElementById('admin-login-view').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            navigateTo('dashboard-page');
            await loadInitialData();
        } else {
            document.getElementById('admin-login-view').style.display = 'flex';
            document.getElementById('admin-dashboard').style.display = 'none';
        }
    };
    
    async function loadInitialData() {
        await loadUsers(); 
        await loadProducts();
        updateDashboardStats();
    }

    // --- AUTHENTICATION ---
    function showLoginError(message) { document.getElementById('login-error').textContent = message; }
    async function handleAdminLogin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        showLoginError('');
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            showLoginError(error.message);
        } else {
            window.location.reload();
        }
    }

    async function handleAdminLogout() {
        await supabase.auth.signOut();
        window.location.reload();
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
        document.getElementById('admin-logout-btn').addEventListener('click', handleAdminLogout);
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); }));
        document.getElementById('menu-toggle').addEventListener('click', () => { document.getElementById('sidebar').classList.add('active'); document.getElementById('sidebar-overlay').classList.add('active'); });
        document.getElementById('close-sidebar-btn').addEventListener('click', () => { document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebar-overlay').classList.remove('active'); });
        document.getElementById('sidebar-overlay').addEventListener('click', () => { document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebar-overlay').classList.remove('active'); });
        document.getElementById('user-search').addEventListener('input', (e) => renderUsersTable(e.target.value));
        
        // Product Modal
        document.getElementById('add-product-btn').addEventListener('click', () => openProductModal());
        document.getElementById('product-modal-close-btn').addEventListener('click', () => document.getElementById('product-modal').classList.remove('active'));
        document.getElementById('product-modal-cancel-btn').addEventListener('click', () => document.getElementById('product-modal').classList.remove('active'));
        document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
        document.getElementById('add-size-btn').addEventListener('click', () => addSizeInput());
    }

    // --- UI & NAVIGATION ---
    function navigateTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.page === pageId) link.classList.add('active');
        });
        if (window.innerWidth < 1024) {
             document.getElementById('sidebar').classList.remove('active');
             document.getElementById('sidebar-overlay').classList.remove('active');
        }
    }
    
    // --- DATA LOADING & RENDERING ---
    async function loadUsers() {
        const { data, error } = await supabase.from('users').select('*');
        if (error) {
            showAlert('Error fetching users: ' + error.message);
            return;
        }
        allUsers = data || [];
        renderUsersTable();
    }

    async function loadProducts() {
        const { data, error } = await supabase.from('products').select('*');
        if (error) {
            showAlert('Error fetching products: ' + error.message);
            return;
        }
        allProducts = data || [];
        renderProductsTable();
    }

    function updateDashboardStats() {
        document.getElementById('total-users').textContent = allUsers.length;
        document.getElementById('total-products').textContent = allProducts.length;
    }

    // --- USER MANAGEMENT ---
    function renderUsersTable(searchTerm = '') {
        const tableBody = document.getElementById('users-table-body');
        tableBody.innerHTML = '';
        const filteredUsers = allUsers.filter(user => 
            (user.username || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (user.email || '').toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        filteredUsers.forEach(user => {
            const isBlocked = user.is_blocked || false;
            const flags = user.flags || 0;
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td class="font-medium">${user.username || 'N/A'}</td>
                <td>${user.email}</td>
                <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${isBlocked ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${isBlocked ? 'Blocked' : 'Active'}</span></td>
                <td>${flags > 0 ? `<span class="text-red-500 font-bold">${flags} Flags</span>` : 'None'}</td>
                <td class="space-x-2 whitespace-nowrap">
                    <button class="btn bg-yellow-500 text-white text-xs flag-user-btn" data-user-id="${user.id}">Flag</button>
                    <button class="btn ${isBlocked ? 'bg-green-500 hover:bg-green-600' : 'btn-danger'} text-white text-xs block-user-btn" data-user-id="${user.id}" data-is-blocked="${isBlocked}">${isBlocked ? 'Unblock' : 'Block'}</button>
                </td>`;
        });

        document.querySelectorAll('.flag-user-btn').forEach(btn => btn.addEventListener('click', (e) => flagUser(e.target.dataset.userId)));
        document.querySelectorAll('.block-user-btn').forEach(btn => btn.addEventListener('click', (e) => toggleBlockUser(e.target.dataset.userId, e.target.dataset.isBlocked === 'true')));
    }

    async function flagUser(userId) {
        const user = allUsers.find(u => u.id === parseInt(userId));
        const currentFlags = user.flags || 0;
        showConfirm(`Are you sure you want to add a red flag to this user?`, async () => {
            const { error } = await supabase.from('users').update({ flags: currentFlags + 1 }).eq('id', userId);
            if (error) {
                showAlert('Error flagging user: ' + error.message);
            } else {
                showAlert('User has been flagged.');
                await loadUsers();
            }
        });
    }

    function toggleBlockUser(userId, isCurrentlyBlocked) {
        const action = isCurrentlyBlocked ? 'unblock' : 'block';
        showConfirm(`Are you sure you want to ${action} this user?`, async () => {
             const { error } = await supabase.from('users').update({ is_blocked: !isCurrentlyBlocked }).eq('id', userId);
             if (error) {
                 showAlert(`Error ${action}ing user: ` + error.message);
             } else {
                showAlert(`User has been ${action}ed.`);
                await loadUsers();
             }
        });
    }

    // --- PRODUCT MANAGEMENT ---
    function renderProductsTable() {
        const tableBody = document.getElementById('products-table-body');
        tableBody.innerHTML = '';
        allProducts.forEach(p => {
            const row = tableBody.insertRow();
            const minPrice = p.sizes && p.sizes.length > 0 ? Math.min(...p.sizes.map(s => s.price)) : 0;
            row.innerHTML = `
                <td class="font-medium">${p.name}</td>
                <td>${p.category}</td>
                <td>Starts at ₹${minPrice}</td>
                <td class="space-x-2 whitespace-nowrap">
                    <button class="btn btn-secondary text-xs edit-product-btn" data-product-id="${p.id}">Edit</button>
                    <button class="btn btn-danger text-xs delete-product-btn" data-product-id="${p.id}">Delete</button>
                </td>`;
        });

        document.querySelectorAll('.edit-product-btn').forEach(b => b.onclick = (e) => openProductModal(allProducts.find(p => p.id === parseInt(e.target.dataset.productId))));
        document.querySelectorAll('.delete-product-btn').forEach(b => b.onclick = (e) => deleteProduct(e.target.dataset.productId));
    }

    function openProductModal(product = null) {
        const form = document.getElementById('product-form');
        form.reset();
        document.getElementById('product-id').value = '';
        document.getElementById('p-sizes-container').innerHTML = '';
        
        if (product) {
            document.getElementById('product-modal-title').textContent = "Edit Product";
            document.getElementById('product-id').value = product.id;
            document.getElementById('p-name').value = product.name;
            document.getElementById('p-description').value = product.description;
            document.getElementById('p-category').value = product.category;
            document.getElementById('p-image').value = product.image;
            if(product.sizes && product.sizes.length > 0) {
                product.sizes.forEach(size => addSizeInput(size.volume, size.price));
            }
        } else {
             document.getElementById('product-modal-title').textContent = "Add Product";
             addSizeInput('30ml', ''); // Add one default size input
        }
        document.getElementById('product-modal').classList.add('active');
    }

    function addSizeInput(volume = '', price = '') {
        const container = document.getElementById('p-sizes-container');
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        div.innerHTML = `
            <input type="text" value="${volume}" class="w-1/3 px-3 py-2 border rounded-lg" placeholder="e.g., 50ml" required>
            <input type="number" value="${price}" class="w-1/3 px-3 py-2 border rounded-lg" placeholder="Price (₹)" required>
            <button type="button" class="btn btn-danger text-xs remove-size-btn">Remove</button>
        `;
        container.appendChild(div);
        div.querySelector('.remove-size-btn').addEventListener('click', () => div.remove());
    }

    async function handleProductFormSubmit(e){
        e.preventDefault();
        const productId = document.getElementById('product-id').value;
        const sizes = [];
        document.querySelectorAll('#p-sizes-container > div').forEach(div => {
            const inputs = div.querySelectorAll('input');
            const volume = inputs[0].value;
            const price = parseInt(inputs[1].value);
            if(volume && !isNaN(price)) {
                sizes.push({ volume, price });
            }
        });
        
        const productData = {
            name: document.getElementById('p-name').value,
            description: document.getElementById('p-description').value,
            category: document.getElementById('p-category').value,
            image: document.getElementById('p-image').value,
            sizes: sizes,
            featured: false // Default value
        };

        let query;
        if(productId){
            query = supabase.from('products').update(productData).eq('id', productId);
        } else {
            query = supabase.from('products').insert([productData]);
        }

        const { error } = await query;
        if (error) {
            showAlert('Error saving product: ' + error.message);
        } else {
            showAlert(productId ? 'Product updated successfully!' : 'Product created successfully!');
            document.getElementById('product-modal').classList.remove('active');
            await loadProducts();
            updateDashboardStats();
        }
    }

    async function deleteProduct(productId) {
        showConfirm("Are you sure you want to delete this product? This cannot be undone.", async () => {
            const { error } = await supabase.from('products').delete().eq('id', productId);
            if(error) {
                showAlert('Error deleting product: ' + error.message);
            } else {
                showAlert("Product deleted.");
                await loadProducts();
                updateDashboardStats();
            }
        });
    }

    // --- UTILITY MODALS ---
    function showAlert(message) {
        const alertModal = document.getElementById('custom-alert');
        document.getElementById('alert-message').textContent = message;
        alertModal.classList.remove('hidden'); alertModal.classList.add('flex');
        document.getElementById('alert-ok-btn').onclick = () => { alertModal.classList.add('hidden'); alertModal.classList.remove('flex'); };
    }

    function showConfirm(message, onConfirm) {
        const confirmModal = document.getElementById('custom-confirm');
        document.getElementById('confirm-message').textContent = message;
        confirmModal.classList.remove('hidden'); confirmModal.classList.add('flex');
        const okListener = () => { onConfirm(); cleanup(); };
        const cancelListener = () => cleanup();
        const cleanup = () => {
            confirmModal.classList.add('hidden'); confirmModal.classList.remove('flex');
            document.getElementById('confirm-ok-btn').removeEventListener('click', okListener);
            document.getElementById('confirm-cancel-btn').removeEventListener('click', cancelListener);
        };
        document.getElementById('confirm-ok-btn').addEventListener('click', okListener, { once: true });
        document.getElementById('confirm-cancel-btn').addEventListener('click', cancelListener, { once: true });
    }
</script>
</body>
</html>
